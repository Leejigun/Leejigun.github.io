<!-- footer도 여기에 있음 -->


<!DOCTYPE html>
<html>
<head>

    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- iOS-tip 이라고 태그를 만들었으면 post에서는 iOS tip 이라고 태그를 줘야한다. -->
<!-- dynamically fixing the title for tag/author pages -->



    <title>CoreBluetooth 가이드</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />
    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="ios Fido 프로젝트를 진행하면서 CoreBluetooth를 다룬 경험을 포스팅한다." />
    <link rel="shortcut icon" href="https://leejigun.github.io//assets/images/blog-icon.png" type="image/png" />
    <link rel="canonical" href="https://leejigun.github.io//CoreBlutooth" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="iOS 삽질 블로그" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="CoreBluetooth 가이드" />
    <meta property="og:description" content="CoreBluetooth 프로젝트를 진행한 경험을 포스팅한다. Core Bluetooth Programming Guide Central과 Periphral 최근 Fido 생체 인증 개발을 진행하면서 생체 인증 기기를 어플리케이션에 연동하는 작업을 진행하게 되면서 격은 경험을 포스팅 하려고 합니다. iOS에서 CoreBluetooth 프레임워크를 사용하면서 격게되는 여러가지 트러블 슈팅과 관련해서 적어 내려가려 하는데, 이 글이 누군가에게 도움이 되었으면 좋겠습니다. iOS 개발에서" />
    <meta property="og:url" content="https://leejigun.github.io//CoreBlutooth" />
    <meta property="og:image" content="https://leejigun.github.io//assets/images/CoreBluetooth/first.png" />
    <meta property="article:publisher" content="https://www.facebook.com/" />
    <meta property="article:author" content="https://www.facebook.com/" />
    <meta property="article:published_time" content="2018-03-29T09:00:00+09:00" />
    <meta property="article:modified_time" content="2018-03-29T09:00:00+09:00" />
    <meta property="article:tag" content="Ios" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="CoreBluetooth 가이드" />
    <meta name="twitter:description" content="CoreBluetooth 프로젝트를 진행한 경험을 포스팅한다. Core Bluetooth Programming Guide Central과 Periphral 최근 Fido 생체 인증 개발을 진행하면서 생체 인증 기기를 어플리케이션에 연동하는 작업을 진행하게 되면서 격은 경험을 포스팅 하려고 합니다. iOS에서 CoreBluetooth 프레임워크를 사용하면서 격게되는 여러가지 트러블 슈팅과 관련해서 적어 내려가려 하는데, 이 글이 누군가에게 도움이 되었으면 좋겠습니다. iOS 개발에서" />
    <meta name="twitter:url" content="https://leejigun.github.io//" />
    <meta name="twitter:image" content="https://leejigun.github.io//assets/images/CoreBluetooth/first.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="iOS 삽질 블로그" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Ios" />
    <meta name="twitter:site" content="@" />
    <meta name="twitter:creator" content="@" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "iOS 삽질 블로그",
        "logo": "https://leejigun.github.io//assets/images/blog-icon.png"
    },
    "url": "https://leejigun.github.io//CoreBlutooth",
    "image": {
        "@type": "ImageObject",
        "url": "https://leejigun.github.io//assets/images/CoreBluetooth/first.png",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://leejigun.github.io//CoreBlutooth"
    },
    "description": "CoreBluetooth 프로젝트를 진행한 경험을 포스팅한다. Core Bluetooth Programming Guide Central과 Periphral 최근 Fido 생체 인증 개발을 진행하면서 생체 인증 기기를 어플리케이션에 연동하는 작업을 진행하게 되면서 격은 경험을 포스팅 하려고 합니다. iOS에서 CoreBluetooth 프레임워크를 사용하면서 격게되는 여러가지 트러블 슈팅과 관련해서 적어 내려가려 하는데, 이 글이 누군가에게 도움이 되었으면 좋겠습니다. iOS 개발에서"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="CoreBluetooth 가이드" href="/feed.xml" />


</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->

        <!-- HTML elements for search -->

        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <!-- 네비게이션 바 -->
<nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="https://leejigun.github.io//"><img src="/assets/images/blog-icon.png" alt="iOS 삽질 블로그" /></a>
            
        
        
            <!-- 여기서 navigation 에 표시할 이이템 추가 -->
<ul class="nav" role="menu">
    <li class="nav-home" role="menuitem"><a href="/">Home</a></li>
    <li class="nav-about" role="menuitem"><a href="/about/">About</a></li>
    <li class="nav-getting-started" role="menuitem"><a href="/tag/ios/">iOS</a></li>
    <li class="nav-getting-started" role="menuitem"><a href="/tag/watchos/">watchOS</a></li>
    <li class="nav-getting-started" role="menuitem"><a href="/tag/rxswift/">RxSwift</a></li>
    <li class="nav-getting-started" role="menuitem"><a href="/tag/swiftui/">swiftui</a></li>
    <li class="nav-getting-started" role="menuitem"><a href="/tag/project/">project</a></li>
    <li class="nav-getting-started" role="menuitem"><a href="/tag/ml/">ML</a></li>
    <li class="nav-getting-started" role="menuitem"><a href="/tag/cs/">CS</a></li>
    <li class="nav-getting-started" role="menuitem"><a href="/tag/flutter/">flutter</a></li>
    <li class="nav-try-ghost" role="menuitem"><a href="https://github.com/Leejigun">github</a></li>
    <li class="nav-try-ghost" role="menuitem"><a href="/search.html">Search</a></li>
</ul>

        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
            
        </div>
        
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full post tag-getting-started ">

            <header class="post-full-header">
                <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime="29 March 2018">29 March 2018</time>
                    
                        <span class="date-divider">/</span>
                        
                            
                               <a href='/tag/ios/'>IOS</a>
                            
                        
                    
                </section>
                <h1 class="post-full-title">CoreBluetooth 가이드</h1>
            </header>

            
            <figure class="post-full-image" style="background-image: url(/assets/images/CoreBluetooth/first.png)">
            </figure>
            

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <ul>
  <li>CoreBluetooth 프로젝트를 진행한 경험을 포스팅한다.</li>
  <li><a href="https://developer.apple.com/library/content/documentation/NetworkingInternetWeb/Conceptual/CoreBluetooth_concepts/AboutCoreBluetooth/Introduction.html">Core Bluetooth Programming Guide</a></li>
</ul>

<h2 id="central과-periphral">Central과 Periphral</h2>

<p>최근 Fido 생체 인증 개발을 진행하면서 생체 인증 기기를 어플리케이션에 연동하는 작업을 진행하게 되면서 격은 경험을 포스팅 하려고 합니다. iOS에서 CoreBluetooth 프레임워크를 사용하면서 격게되는 여러가지 트러블 슈팅과 관련해서 적어 내려가려 하는데, 이 글이 누군가에게 도움이 되었으면 좋겠습니다.</p>

<p>iOS 개발에서 사수 없이 혼자 <a href="https://developer.apple.com/library/content/documentation/NetworkingInternetWeb/Conceptual/CoreBluetooth_concepts/AboutCoreBluetooth/Introduction.html">apple 프로그래밍 가이드</a>를 읽고 개발을 진행하면서 영어로된 문서지만 많이 어려운 내용이 아니라 어느정도 읽고 개발에 들어가면 큰 도움이 될거 같습니다.</p>

<p>아래의 내용은 제가 하나도 모르는 상태에서 개발자 가이드와 여러 가이드 문서를 읽으며 학습한 내용을 그대로 적은것 입니다. 만약, 이것을 읽고 내용을 다 흡수한다면 저보다는 CoreBluretooth 프레임워크를 잘 이해하고 있다고 자신 하셔도 됩니다.</p>

<p>먼저, iOS의 corebluetooth 프레임워크를 사용할 때 정확하게 잡고 가야 하는 개념으로는 Central과 Peirpheral의 역할를 이해해야 합니다. 데이터를 받아오고 처리하는 기기가 Cental의 역할을 맡게되고 데이터를 측정하고 Central로 데이터를 전송하는 기기를 Peripheral 이라 합니다.</p>

<p>저의 경우에는 사용자의 정보를 측정해 이 사용자를 구분하는 인증기(Authenticator)를 Peirpheral로 보고, 인증기가 가져온 데이터를 가공 사용자에게 제공하거나 서버로 올리는 iPhone을 Central이라 볼 수 있습니다. 이 역할은 항상 상대적인 것으로 iPhone이 Peirpheral의 역할을 수행하고 다른 장비가 Central의 역할을 수행 할 수 도 있습니다.</p>

<p>다행이 그 어떤 역할을 수행하게 되더라도 iOS의 CoreBlutooth 프레임워크는 복잡한 역할을 간단하게 수행할 수 있도록 추상화를 제공합니다. 그 중 저는 Central의 역할을 수행하기 위해서 CentralManager를 생성하고 관리할 필요가 있습니다.</p>

<hr />

<h2 id="centralmanager">CentralManager</h2>

<p><img src="../assets/images/CoreBluetooth/completed.png" alt="완성 화면" /></p>

<p><strong>위 화면에 들어갈 기능은 다음과 같습니다.</strong></p>

<hr />

<ol>
  <li>주변 장치 검색</li>
  <li>과거 연결 장치 자동 연결</li>
  <li>장치 검색시 특정 서비스를 제공하는 장치만 선별 검색</li>
  <li>검색 장치를 table에 보여주기</li>
  <li>선택시 해당 장치 연결</li>
</ol>

<h4 id="1-cbcentalmanager-생성">1. CBCentalManager 생성</h4>

<p>tableViewController(BluetoothTableViewController)를 만들고 CoreBluetooth 프레임워크를 추가합니다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">BluetoothTableViewController</span><span class="o">.</span><span class="n">h</span>
<span class="cp">#import &lt;CoreBluetooth/CoreBluetooth.h&gt;</span>
</code></pre></div></div>

<p>iOS 기기가 Central 역할을 수행할 수 있도록 관리해줄 CentralManager 객체를 정의합니다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">BluetoothTableViewController</span><span class="o">.</span><span class="n">h</span>
<span class="kd">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="kt">CBCentralManager</span> <span class="o">*</span><span class="n">centralManager</span><span class="p">;</span>
</code></pre></div></div>

<p>추가적으로 <code class="highlighter-rouge">ViewController</code>가 <code class="highlighter-rouge">CentralManager</code>의 이벤트를 수행할 수 있도록 <code class="highlighter-rouge">CBCentralManagerDelegate</code>를 구현해야 합니다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">BluetoothTableViewController</span><span class="o">.</span><span class="n">h</span>
<span class="kd">@interface</span> <span class="kt">BluetoothTableViewController</span> <span class="p">:</span> <span class="kt">UITableViewController</span><span class="o">&lt;</span><span class="kt">UITableViewDelegate</span><span class="p">,</span><span class="kt">CBCentralManagerDelegate</span><span class="o">&gt;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">BluetoothTableViewController.m</code> 파일로<code class="highlighter-rouge">_centralManager</code>를 생성하고 이벤트를 처리할 <code class="highlighter-rouge">delegate</code>로 <code class="highlighter-rouge">BluetoothTableViewController</code>를 지정합니다. 이제 <code class="highlighter-rouge">centralManger</code> 를 통해서 블루투스 기능을 사용하고 관리할 수 있게 되었습니다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">BluetoothTableViewController</span><span class="o">.</span><span class="n">m</span>
<span class="o">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">viewDidLoad</span> <span class="p">{</span>
    <span class="p">[</span><span class="k">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
    <span class="n">_centralManager</span> <span class="o">=</span> <span class="p">[[</span><span class="kt">CBCentralManager</span> <span class="n">alloc</span><span class="p">]</span> <span class="nv">initWithDelegate</span><span class="p">:</span><span class="k">self</span> <span class="nv">queue</span><span class="p">:</span><span class="kc">nil</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="2-bluetooth-상태-확인하기">2. Bluetooth 상태 확인하기</h4>

<p>CentralManager를 통해서 디바이스의 블루투스 상태를 확인 할 수 있습니다. 기존의 로직 처리는 아래와 같이 상태가 변경될 때 마다 호출되는 메소드에서 상태값을 체크하는 방식으로 구현했습니다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="nv">centralManagerDidUpdateState</span><span class="p">:(</span><span class="n">nonnull</span> <span class="kt">CBCentralManager</span> <span class="o">*</span><span class="p">)</span><span class="n">central</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">central</span><span class="o">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="kt">CBManagerStateUnknown</span><span class="p">:</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="kt">CBManagerStateResetting</span><span class="p">:</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="kt">CBManagerStateUnsupported</span><span class="p">:</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="kt">CBManagerStateUnauthorized</span><span class="p">:</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="kt">CBManagerStatePoweredOff</span><span class="p">:</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="kt">CBManagerStatePoweredOn</span><span class="p">:</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">CentralManager</code>가 생성될 때 한번 호출되고 나중에 상태가 변경될 때 마다 호출되기 때문에 필요한 로직을 추가 할 수 있습니다. 우리가 주변 장치를 찾을 수 있는 유일한 상태는 <code class="highlighter-rouge">CBManagerStatePoweredOn</code> 뿐입니다.</p>

<p><strong>다만, 이런 처리 로직은 더 이상 권장하지 않습니다.</strong></p>

<p>이제는 블루투스 기능이 꺼져있다면 app을 키면 iOS에서 설정으로 이동할 수 있는 얼럿 박스가 자동으로 표시되기 때문에 이제는 메세지를 무시하고 그냥 스캔하려고 했을 경우에만 처리하는 로직을 넣어주면 됩니다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="nv">startSearch</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="n">sender</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_centralManager</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="kt">CBManagerStatePoweredOn</span><span class="p">){</span>
            <span class="kt">NSLog</span><span class="p">(</span><span class="s">@"Start Search"</span><span class="p">);</span>
            <span class="p">[</span><span class="n">_peripheralList</span> <span class="n">removeAllObjects</span><span class="p">];</span>
            <span class="p">[</span><span class="k">self</span><span class="o">.</span><span class="n">tableView</span> <span class="n">reloadData</span><span class="p">];</span>
            <span class="p">[</span><span class="n">_centralManager</span> <span class="nv">scanForPeripheralsWithServices</span><span class="p">:</span><span class="err">@</span><span class="p">[[</span><span class="kt">CBUUID</span> <span class="kt">UUIDWithString</span><span class="p">:</span><span class="s">@"0xFF00"</span><span class="p">]]</span> <span class="nv">options</span><span class="p">:</span><span class="kc">nil</span><span class="p">];</span>
            <span class="kt">UIBarButtonItem</span> <span class="o">*</span><span class="n">stop</span> <span class="o">=</span> <span class="p">[[</span><span class="kt">UIBarButtonItem</span> <span class="n">alloc</span><span class="p">]</span> <span class="nv">initWithBarButtonSystemItem</span><span class="p">:</span><span class="kt">UIBarButtonSystemItemStop</span> <span class="nv">target</span><span class="p">:</span><span class="k">self</span> <span class="nv">action</span><span class="p">:</span><span class="kd">@selector(stopSearch:)</span><span class="p">];</span>
            <span class="k">self</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span> <span class="o">=</span> <span class="n">stop</span><span class="p">;</span>
            <span class="p">[[</span><span class="kt">UIApplication</span> <span class="n">sharedApplication</span><span class="p">]</span> <span class="nv">setNetworkActivityIndicatorVisible</span><span class="p">:</span><span class="kt">YES</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="p">[</span><span class="k">self</span> <span class="kt">ShowBluetoothSettingAlert</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="o">-</span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="kt">ShowBluetoothSettingAlert</span> <span class="p">{</span>
    <span class="kt">UIAlertAction</span> <span class="o">*</span><span class="n">cancel</span> <span class="o">=</span> <span class="p">[</span><span class="kt">UIAlertAction</span> <span class="nv">actionWithTitle</span><span class="p">:</span><span class="s">@"cancel"</span> <span class="nv">style</span><span class="p">:</span><span class="kt">UIAlertActionStyleDestructive</span> <span class="nv">handler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">UIAlertAction</span> <span class="o">*</span> <span class="n">_Nonnull</span> <span class="n">action</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}];</span>
    <span class="kt">UIAlertAction</span> <span class="o">*</span><span class="n">goOption</span> <span class="o">=</span> <span class="p">[</span><span class="kt">UIAlertAction</span> <span class="nv">actionWithTitle</span><span class="p">:</span><span class="s">@"setting"</span> <span class="nv">style</span><span class="p">:</span><span class="kt">UIAlertActionStyleDefault</span> <span class="nv">handler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">UIAlertAction</span> <span class="o">*</span> <span class="n">_Nonnull</span> <span class="n">action</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[[</span><span class="kt">UIApplication</span> <span class="n">sharedApplication</span><span class="p">]</span> <span class="nv">openURL</span><span class="p">:[</span><span class="kt">NSURL</span> <span class="kt">URLWithString</span><span class="p">:</span><span class="s">@"App-Prefs:root=Bluetooth"</span><span class="p">]</span> <span class="nv">options</span><span class="p">:</span><span class="err">@</span><span class="p">{}</span> <span class="nv">completionHandler</span><span class="p">:</span><span class="kc">nil</span><span class="p">];</span>
    <span class="p">}];</span>
    <span class="p">[</span><span class="kt">OpenitUtils</span> <span class="nv">showAlertBox</span><span class="p">:</span><span class="k">self</span> <span class="kt">Title</span><span class="p">:</span><span class="s">@"Openit Fido"</span> <span class="kt">Message</span><span class="p">:</span><span class="s">@"Plz check your Device's Bluetooth setting"</span> <span class="kt">Actions</span><span class="p">:</span><span class="err">@</span><span class="p">[</span><span class="n">cancel</span><span class="p">,</span><span class="n">goOption</span><span class="p">]];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>블루투스 설정을 열기 위해서<code class="highlighter-rouge">[[UIApplication sharedApplication] openURL:[NSURL URLWithString:@"App-Prefs:root=Bluetooth"] options:@{} completionHandler:nil];</code> 메소드를 사용했습니다. 다른 설정을 여는 것도 가능하니 기억하고 있다가 필요할 때 검색을 해봅시다.</p>

<h4 id="3-주변-기기-스캔">3. 주변 기기 스캔</h4>

<p>이 centralManager를 통해서 주변 장치를 Scan해 블루투스 4.0을 지원하는 장비들을 찾을 수 있습니다. 스캔을 할 때에는 파라미터로 서비스를 지정해 주는걸 권장하고 있습니다. 계속해서 무작위 전체 기기를 검색하는 것은 리소스를 많이 소모하게 됩니다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 이때 Service에 특정 서비스의 UUID를 통해 그 서비스를 지원하는 장치만 찾을 수 있다.</span>
<span class="p">[</span><span class="n">_centralManager</span> <span class="nv">scanForPeripheralsWithServices</span><span class="p">:</span><span class="err">@</span><span class="p">[[</span><span class="kt">CBUUID</span> <span class="kt">UUIDWithString</span><span class="p">:</span><span class="s">@"0xFF00"</span><span class="p">]]</span> <span class="nv">options</span><span class="p">:</span><span class="kc">nil</span><span class="p">];</span>
<span class="c1">// 혹은 이미 특정 기기의 UUID를 알고 있다면 이 방법으로 특정 기기 정보만을 스캔할 수 있다.</span>
<span class="kt">NSUUID</span> <span class="o">*</span><span class="n">uuid</span> <span class="o">=</span> <span class="p">[[</span><span class="kt">NSUUID</span> <span class="n">alloc</span><span class="p">]</span> <span class="nv">initWithUUIDString</span><span class="p">:</span><span class="n">uuidString</span><span class="p">];</span>
<span class="kt">NSArray</span><span class="o">*</span> <span class="n">periphralarray</span> <span class="o">=</span> <span class="p">[</span><span class="n">_centralManager</span> <span class="nv">retrievePeripheralsWithIdentifiers</span><span class="p">:</span><span class="err">@</span><span class="p">[</span><span class="n">uuid</span><span class="p">]];</span>
</code></pre></div></div>

<p>scan에서 줄 수 있는 옵션은 아래와 같습니다.</p>

<ul>
  <li><a href="apple-reference-documentation://hcCbC3oG6V"><code class="highlighter-rouge">CBCentralManagerScanOptionAllowDuplicatesKey</code></a></li>
  <li><a href="apple-reference-documentation://hcAaTnSNz7"><code class="highlighter-rouge">CBCentralManagerScanOptionSolicitedServiceUUIDsKey</code></a></li>
</ul>

<p>Scanning 중 장치를 발견할 때 마다 delegate의 <code class="highlighter-rouge">didDiscoverPeripheral</code> 메소드가 호출되는데 우리는 발견한 장치들을 table에 보여줄 것이기 때문에 그에 따른 처리가 필요합니다. (TableView를 다루는 방법은 생략합니다. 여기까지 오셨으면 다들 하실 수 있을거라 믿습니다.)</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="nv">centralManager</span><span class="p">:(</span><span class="kt">CBCentralManager</span> <span class="o">*</span><span class="p">)</span><span class="n">central</span> <span class="nv">didDiscoverPeripheral</span><span class="p">:(</span><span class="kt">CBPeripheral</span> <span class="o">*</span><span class="p">)</span><span class="n">peripheral</span> <span class="nv">advertisementData</span><span class="p">:(</span><span class="kt">NSDictionary</span><span class="o">&lt;</span><span class="kt">NSString</span> <span class="o">*</span><span class="p">,</span><span class="n">id</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span><span class="n">advertisementData</span> <span class="kt">RSSI</span><span class="p">:(</span><span class="kt">NSNumber</span> <span class="o">*</span><span class="p">)</span><span class="kt">RSSI</span> <span class="p">{</span>
	<span class="c1">//발견한 장치를 logging</span>
    <span class="kt">NSLog</span><span class="p">(</span><span class="s">@"Discovered %@ at %@"</span><span class="p">,</span> <span class="n">peripheral</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kt">RSSI</span><span class="p">);</span>

    <span class="c1">//내 프로젝트에서는 특정 장비만 지원하는 Fido asm의 역할을 수행하기 때문에 필터링을 한다.</span>
    <span class="kt">NSString</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="p">[</span><span class="n">peripheral</span><span class="o">.</span><span class="n">name</span> <span class="nv">stringByTrimmingCharactersInSet</span><span class="p">:[</span><span class="kt">NSCharacterSet</span> <span class="n">whitespaceCharacterSet</span><span class="p">]];</span>

    <span class="k">if</span> <span class="p">([</span><span class="n">name</span> <span class="nv">hasPrefix</span><span class="p">:</span><span class="s">@"Mhealth2"</span><span class="p">])</span> <span class="p">{</span>
        <span class="kt">CBPeripheral</span> <span class="o">*</span><span class="n">discovered</span> <span class="o">=</span> <span class="p">[</span><span class="n">peripheral</span> <span class="n">copy</span><span class="p">];</span>
        <span class="p">[</span><span class="n">_peripheralList</span> <span class="nv">addObject</span><span class="p">:</span><span class="n">discovered</span><span class="p">];</span>
        <span class="p">[</span><span class="k">self</span><span class="o">.</span><span class="n">tableView</span> <span class="n">reloadData</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="4-선택-기기-연결">4. 선택 기기 연결</h4>

<p>tableView에 표시된 기기 중 선택 기기를 연결하려고 한다. <code class="highlighter-rouge">didSelectRowAtIndexPath</code> 에 로직을 추가하자.</p>

<p>제 경우 비지니스 모델이 인증기 회사와 협업하여 특정 기기에 타겟팅되어 개발했습니다. 그 기기 전용으로 앱을 만들었기 때문에 이름으로 필터링을 했습니다. 그럼에도 혹시 같은 장소에 여러 동일한 기기가 있을 경우를 생각해 선택해서 연결하는 방식을 취했습니다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="nv">tableView</span><span class="p">:(</span><span class="kt">UITableView</span> <span class="o">*</span><span class="p">)</span><span class="n">tableView</span> <span class="nv">didSelectRowAtIndexPath</span><span class="p">:(</span><span class="kt">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="n">indexPath</span> <span class="p">{</span>
    <span class="kt">CBPeripheral</span> <span class="o">*</span><span class="n">selectedPeripheral</span> <span class="o">=</span> <span class="p">(</span><span class="kt">CBPeripheral</span><span class="o">*</span><span class="p">)</span><span class="n">_peripheralList</span><span class="p">[</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="p">];</span>
    <span class="kt">NSLog</span><span class="p">(</span><span class="s">@"try connect :%@"</span><span class="p">,</span><span class="n">selectedPeripheral</span><span class="o">.</span><span class="n">name</span><span class="p">);</span>
    <span class="n">_discoveredPeripheral</span> <span class="o">=</span> <span class="n">selectedPeripheral</span><span class="p">;</span>
    <span class="p">[</span><span class="k">self</span> <span class="n">connetSelectedPeriphral</span><span class="p">];</span>
<span class="p">}</span>
<span class="o">-</span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">connetSelectedPeriphral</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">_prograss</span> <span class="nv">setLabelText</span><span class="p">:</span><span class="s">@"Openit FIDO"</span><span class="p">];</span>
    <span class="p">[</span><span class="n">_prograss</span> <span class="nv">setDetailsLabelText</span><span class="p">:</span><span class="s">@"connecting with device"</span><span class="p">];</span>
    <span class="p">[</span><span class="n">_prograss</span> <span class="nv">showUsingAnimation</span><span class="p">:</span><span class="kt">YES</span><span class="p">];</span>
    <span class="p">[</span><span class="n">_centralManager</span> <span class="nv">connectPeripheral</span><span class="p">:</span><span class="n">_discoveredPeripheral</span> <span class="nv">options</span><span class="p">:</span><span class="err">@</span><span class="p">{</span><span class="kt">CBConnectPeripheralOptionNotifyOnConnectionKey</span><span class="p">:</span><span class="kd">@YES</span><span class="p">}];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>이 커넥션은 조금 특이한데 한번 기기와 커넥션을 시도하면 타임아웃 없이 연결될 때 까지 계속 신호를 전송하게 됩니다. 현재 테스트 하는 기기의 경우 연결까지 20초 정도 시간이 소요되었는데, 연결이 너무 지연되었을 경우데 따른 로직도 추가 할 수 있습니다. 만약, 너무 지연될 경우 연결 신호를 계속 전송하는 자원을 낭비하기 때문에 수동으로 중지 가능하다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 이 메소드의 경우</span>
<span class="p">[</span><span class="n">_centralManager</span> <span class="nv">cancelPeripheralConnection</span><span class="p">:</span><span class="n">_discoveredPeripheral</span><span class="p">];</span>
</code></pre></div></div>

<p>연결이 완료되면 CentralManager의 delegate에서 <code class="highlighter-rouge">didConnectPeripheral:</code> 메소드가 호출되고 이후 기기의 정보를 받아오거나 수정 할 수 있게 됩니다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="nv">centralManager</span><span class="p">:(</span><span class="kt">CBCentralManager</span> <span class="o">*</span><span class="p">)</span><span class="n">central</span> <span class="nv">didFailToConnectPeripheral</span><span class="p">:(</span><span class="kt">CBPeripheral</span> <span class="o">*</span><span class="p">)</span><span class="n">peripheral</span> <span class="nv">error</span><span class="p">:(</span><span class="kt">NSError</span> <span class="o">*</span><span class="p">)</span><span class="n">error</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">NSLog</span><span class="p">(</span><span class="s">@"%@"</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">debugDescription</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">_discoveredPeripheral</span> <span class="o">=</span> <span class="n">peripheral</span><span class="p">;</span>
    <span class="p">[</span><span class="k">self</span> <span class="n">connetSelectedPeriphral</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>기기가 연결에 성공하면 측정을 위해서 다음 화면으로 넘어가도록 구현 했습니다.</p>

<h2 id="peripheral">Peripheral</h2>

<p>기기 연결 후 측정을 위한 화면으로 넘어왔는데(CheckViewController), 여기서 구현해야 하는 다음과 같습니다.</p>

<ul>
  <li>연결된 장치의 서비스와 특성 읽어오기</li>
  <li>응답을 받기를 원하는 특성을 구독하기</li>
  <li>측정을 위해서 기기에 측정 요청 정보 보내기</li>
  <li>기기가 보내는 측정 정보 받기</li>
</ul>

<h4 id="1-cbperipheraldelegate-설정">1. CBPeripheralDelegate 설정</h4>

<p>Central과 마찬가지로 Peripheral과 관련된 다양한 이벤트들을 처리하기 위해서는 delegate protocol을 준수해야합니다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">CheckViewController</span><span class="o">.</span><span class="n">h</span>
<span class="kd">@interface</span> <span class="kt">CheckViewController</span> <span class="p">:</span> <span class="kt">UIViewController</span><span class="o">&lt;</span><span class="kt">CBPeripheralDelegate</span><span class="o">&gt;</span>

<span class="kt">CheckViewController</span><span class="o">.</span><span class="n">m</span>
<span class="o">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">viewDidLoad</span> <span class="p">{</span>
    <span class="p">[</span><span class="k">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
    <span class="c1">// Do any additional setup after loading the view.</span>
    <span class="n">_selectedPeripheral</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="2-서비스-정보-요청">2. 서비스 정보 요청</h4>

<p>_selectedPeripheral은 이전의 controller에서 넘겨받아온 기기 정보로 현재는 이렇다할 정보를 담고 있지 않습니다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//이때 서비스의 UUID를 이미 알고있다면 특정 서비스 정보만 호출 가능하다.</span>
<span class="p">[</span><span class="n">_selectedPeripheral</span> <span class="nv">discoverServices</span><span class="p">:</span><span class="kc">nil</span><span class="p">];</span>
</code></pre></div></div>

<h4 id="3-서비스-요청">3. 서비스 요청</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 이때 특정 서비스의 UUID를 이미 알고 있다면 그 서비스의 정보만 확인 가능하다.</span>
<span class="p">[</span><span class="n">_selectedPeripheral</span> <span class="nv">discoverServices</span><span class="p">:</span><span class="err">@</span><span class="p">[</span> <span class="p">[</span><span class="kt">CBUUID</span> <span class="kt">UUIDWithString</span><span class="p">:</span><span class="kt">WSB_SERVICE_UUID</span><span class="p">]]];</span>
</code></pre></div></div>

<p>서비스 정보를 받게되면 <code class="highlighter-rouge">didDiscoverServices</code>가 호출됩니다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="nv">peripheral</span><span class="p">:(</span><span class="kt">CBPeripheral</span> <span class="o">*</span><span class="p">)</span><span class="n">peripheral</span> <span class="nv">didDiscoverServices</span><span class="p">:(</span><span class="kt">NSError</span> <span class="o">*</span><span class="p">)</span><span class="n">error</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">NSLog</span><span class="p">(</span><span class="s">@"discoverServices error : peripheral: %@, error: %@"</span><span class="p">,</span><span class="n">peripheral</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">error</span><span class="o">.</span><span class="n">debugDescription</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">_selectedPeripheral</span> <span class="o">=</span> <span class="n">peripheral</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">CBService</span> <span class="o">*</span><span class="n">service</span> <span class="k">in</span> <span class="n">peripheral</span><span class="o">.</span><span class="n">services</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">NSLog</span><span class="p">(</span><span class="s">@"discoverd service : %@"</span><span class="p">,</span><span class="n">service</span><span class="o">.</span><span class="n">debugDescription</span><span class="p">);</span>
            <span class="k">if</span><span class="p">([</span><span class="n">service</span><span class="o">.</span><span class="kt">UUID</span><span class="o">.</span><span class="kt">UUIDString</span> <span class="nv">isEqualToString</span><span class="p">:</span><span class="s">@"FF00"</span><span class="p">])</span> <span class="p">{</span>
                <span class="p">[</span><span class="n">peripheral</span> <span class="nv">discoverCharacteristics</span><span class="p">:</span><span class="kc">nil</span> <span class="nv">forService</span><span class="p">:</span><span class="n">service</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>여기서 우리는 FF00에 해당하는 서비스가 제공하는 특성 정보만을 원하기 때문에 필터링을 거친 후 서비스에 대한 특성 정보를 요청한다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">peripheral</span> <span class="nv">discoverCharacteristics</span><span class="p">:</span><span class="kc">nil</span> <span class="nv">forService</span><span class="p">:</span><span class="n">service</span><span class="p">];</span>
</code></pre></div></div>

<p>이때 특성의 UUID를 알고 있다면 그 특성만 요청 할 수 있지만 제 경우에는 모든 특성이 필요하기 때문에 nil로 설정했습니다.</p>

<h4 id="4-특성-구독">4. 특성 구독</h4>

<p>특성이 발견되면 <code class="highlighter-rouge">didDiscoverCharacteristicsForService</code>메소드가 호출된다. 이 메소드에서 특성들을 구독할 수 있습니다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="nv">peripheral</span><span class="p">:(</span><span class="kt">CBPeripheral</span> <span class="o">*</span><span class="p">)</span><span class="n">peripheral</span> <span class="nv">didDiscoverCharacteristicsForService</span><span class="p">:(</span><span class="kt">CBService</span> <span class="o">*</span><span class="p">)</span><span class="n">service</span> <span class="nv">error</span><span class="p">:(</span><span class="kt">NSError</span> <span class="o">*</span><span class="p">)</span><span class="n">error</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">CBCharacteristic</span> <span class="o">*</span><span class="n">charater</span> <span class="k">in</span> <span class="n">service</span><span class="o">.</span><span class="n">characteristics</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">NSLog</span><span class="p">(</span><span class="s">@"discovered Characteristic :%@"</span><span class="p">,</span><span class="n">charater</span><span class="o">.</span><span class="n">debugDescription</span><span class="p">);</span>
        <span class="n">_selectedPeripheral</span> <span class="o">=</span> <span class="n">peripheral</span><span class="p">;</span>
        <span class="n">_selectedPeripheral</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span><span class="p">;</span>
        <span class="p">[</span><span class="n">_selectedPeripheral</span> <span class="nv">setNotifyValue</span><span class="p">:</span><span class="kt">YES</span> <span class="nv">forCharacteristic</span><span class="p">:</span><span class="n">charater</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>현재 이 서비스에서는 2가지 특성을 제공하는데 하나는 측정 정보를 기기가 전송해주는 특성이고 다른 하나는 우리가 데이터를 보내는 데이터를 받기 위한 특성입니다. 기기에 대한 정보가 없어서 많이 처음에 많이 고생했는데, 두 특성 중 하나는 구독이 안되서 구독이 안되는 특성을 데이터를 받기 위해 존재하는 특성 추측하고 개발했습니다.</p>

<p>이 메소드는 2개의 특성을 발견하기 때문에 2번 호출되는데, 어차피 데이터를 보내는 용도로만 사용하는 특성은 구독을 해도 상태값이 변경되지 않도록 막혀 있기 때문에 필터링을 거치지 않았습니다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">_selectedPeripheral</span> <span class="nv">setNotifyValue</span><span class="p">:</span><span class="kt">YES</span> <span class="nv">forCharacteristic</span><span class="p">:</span><span class="n">charater</span><span class="p">];</span>
</code></pre></div></div>

<p>이 메소드를 통해서 특성을 구독할 수 있습니다. 기기가 가진 특성의 noti값을 true로 변경을 요청하면 값이 변경된다면 데이터가 변경되면 자동으로 Central 쪽으로 데이터를 전송합니다.</p>

<p>이 때 noti를 변경하려고 하면 호출되는 메소드가 있는데 여기서 셋팅이 잘 되었는지 확인 할 수 있습니다. 제 경우는 여기서 노티 셋팅이 바뀌지 않는 특성을 저장하는 필터링을 거치도록 했습니다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="nv">peripheral</span><span class="p">:(</span><span class="kt">CBPeripheral</span> <span class="o">*</span><span class="p">)</span><span class="n">peripheral</span> <span class="nv">didUpdateNotificationStateForCharacteristic</span><span class="p">:(</span><span class="kt">CBCharacteristic</span> <span class="o">*</span><span class="p">)</span><span class="n">characteristic</span> <span class="nv">error</span><span class="p">:(</span><span class="kt">NSError</span> <span class="o">*</span><span class="p">)</span><span class="n">error</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">characteristic</span><span class="o">.</span><span class="n">isNotifying</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//정보를 받아오는 케릭터</span>
        <span class="kt">NSLog</span><span class="p">(</span><span class="s">@"Notification began on %@"</span><span class="p">,</span> <span class="n">characteristic</span><span class="p">);</span>
        <span class="n">_stateLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">@"Notification began"</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">//정보를 던져야 하는 캐릭터</span>
        <span class="kt">NSLog</span><span class="p">(</span><span class="s">@"Notification finish on %@"</span><span class="p">,</span> <span class="n">characteristic</span><span class="p">);</span>
        <span class="n">_characteristic</span> <span class="o">=</span> <span class="n">characteristic</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="5-측정-요청-데이터-보내기">5. 측정 요청 (데이터 보내기)</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span> <span class="p">(</span><span class="kt">IBAction</span><span class="p">)</span><span class="nv">measure</span><span class="p">:(</span><span class="kt">UIButton</span> <span class="o">*</span><span class="p">)</span><span class="n">sender</span> <span class="p">{</span>
    <span class="kt">NSData</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="p">[</span><span class="kt">WSB</span> <span class="n">onRegisterData</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">request</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">){</span>
        <span class="p">[</span><span class="n">_selectedPeripheral</span> <span class="nv">writeValue</span><span class="p">:</span><span class="n">request</span> <span class="nv">forCharacteristic</span><span class="p">:</span><span class="n">_characteristic</span> <span class="nv">type</span><span class="p">:</span><span class="kt">CBCharacteristicWriteWithoutResponse</span> <span class="p">];</span>
        <span class="p">[</span><span class="k">self</span> <span class="n">showLoadingView</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>버튼을 누르면 데이터를 보내도록 구현했습니다.  <code class="highlighter-rouge">NSData *request = [WSB onRegisterData];</code> 부분은 신경쓰지 않으셔도 됩니다. 전달 해 줘야 하는 데이터는 기기에 따라 다르니까 개발마다 변경됩니다.</p>

<p>이 때 데이터를 보내는데 사용하는 메소드를 살펴보면.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">_selectedPeripheral</span> <span class="nv">writeValue</span><span class="p">:</span><span class="n">request</span> <span class="nv">forCharacteristic</span><span class="p">:</span><span class="n">_characteristic</span> <span class="nv">type</span><span class="p">:</span><span class="kt">CBCharacteristicWriteWithoutResponse</span> <span class="p">];</span>
</code></pre></div></div>

<p>여기서 제공하는 type 값에는 요청 후 바로 반환값을 받도록 대기하는 <code class="highlighter-rouge">CBCharacteristicWriteWithResponse</code>옵션과 리스폰을 받지 않는 <code class="highlighter-rouge">CBCharacteristicWriteWithoutResponse</code>옵션이 존재합니다.</p>

<p>측정을 요청하면 측정 데이터를 돌려주니 당연히 <code class="highlighter-rouge">CBCharacteristicWriteWithResponse</code>라고 생각하고 계속 시도했지만 실패했습니다. 알고보니 요청 후 나중에 측정이 완료되면 데이터를 반환하기 때문에 <code class="highlighter-rouge">CBCharacteristicWriteWithoutResponse</code>로 설정하고 데이터를 보냈어야 했습니다.</p>

<h4 id="6-데이터-받기">6. 데이터 받기</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="nv">peripheral</span><span class="p">:(</span><span class="kt">CBPeripheral</span> <span class="o">*</span><span class="p">)</span><span class="n">peripheral</span> <span class="nv">didUpdateValueForCharacteristic</span><span class="p">:(</span><span class="kt">CBCharacteristic</span> <span class="o">*</span><span class="p">)</span><span class="n">characteristic</span> <span class="nv">error</span><span class="p">:(</span><span class="kt">NSError</span> <span class="o">*</span><span class="p">)</span><span class="n">error</span> <span class="p">{</span>
    <span class="kt">NSString</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="kt">WSB</span> <span class="nv">dataParser</span><span class="p">:</span><span class="n">characteristic</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="k">self</span> <span class="n">stopLoadingView</span><span class="p">];</span>
        <span class="kt">NSLog</span><span class="p">(</span><span class="s">@"result:%@"</span><span class="p">,</span><span class="n">result</span><span class="p">);</span>

        <span class="k">if</span><span class="p">([</span><span class="n">result</span> <span class="nv">isEqualToString</span><span class="p">:</span><span class="s">@"SUCCESS"</span><span class="p">])</span> <span class="p">{</span>
            <span class="kt">UIAlertAction</span> <span class="o">*</span><span class="n">okAction</span> <span class="o">=</span> <span class="p">[</span><span class="kt">UIAlertAction</span> <span class="nv">actionWithTitle</span><span class="p">:</span><span class="s">@"Done"</span> <span class="nv">style</span><span class="p">:</span><span class="kt">UIAlertActionStyleDefault</span> <span class="nv">handler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">UIAlertAction</span> <span class="o">*</span> <span class="n">_Nonnull</span> <span class="n">action</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">}];</span>
            <span class="p">[</span><span class="kt">OpenitUtils</span> <span class="nv">showAlertBox</span><span class="p">:</span><span class="k">self</span> <span class="kt">Title</span><span class="p">:</span><span class="s">@"Openit FIDO"</span> <span class="kt">Message</span><span class="p">:</span><span class="n">result</span> <span class="kt">Actions</span><span class="p">:</span><span class="err">@</span><span class="p">[</span><span class="n">okAction</span><span class="p">]];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">([</span><span class="n">result</span> <span class="nv">isEqualToString</span><span class="p">:</span><span class="s">@"FAIL"</span><span class="p">]){</span>
            <span class="kt">UIAlertAction</span> <span class="o">*</span><span class="n">okAction</span> <span class="o">=</span> <span class="p">[</span><span class="kt">UIAlertAction</span> <span class="nv">actionWithTitle</span><span class="p">:</span><span class="s">@"Done"</span> <span class="nv">style</span><span class="p">:</span><span class="kt">UIAlertActionStyleDefault</span> <span class="nv">handler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">UIAlertAction</span> <span class="o">*</span> <span class="n">_Nonnull</span> <span class="n">action</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">}];</span>
            <span class="p">[</span><span class="kt">OpenitUtils</span> <span class="nv">showAlertBox</span><span class="p">:</span><span class="k">self</span> <span class="kt">Title</span><span class="p">:</span><span class="s">@"Openit FIDO"</span> <span class="kt">Message</span><span class="p">:</span><span class="n">result</span> <span class="kt">Actions</span><span class="p">:</span><span class="err">@</span><span class="p">[</span><span class="n">okAction</span><span class="p">]];</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>구독한 특성에 대해서 언제든지 측정 기기가 데이터를 보내게 된다면 이 메소드가 호출됩니다. 여기서 측정 결과에 따라 데이터를 파싱하도록 하면 되는데, 위 예문은 테스트 기기이기 때문에 가능한 성공, 실패 분기로 실제 데이터가 어떤 형태일지는 기기와의 데이터 프로토콜에 따라사 바뀔 수 있습니다. (Ex:보통 의료기기일 경우에는 Gatt 표준을 따릅니다.)</p>

<h2 id="etc">etc.</h2>

<p>일단 실 기기가 오기 전에 필요한 부분은 여기까지 였습니다. 현재 시점에서 아직 기기를 받지 못해서 여기까지만 구현했는데, CoreBluetooth와 관련된 내용은 이게 전부라 이걸 참고하셔서 개발하셔도 상관 없습니다.</p>

<p>아래 사항은 개발 중 추가적으로 필요하다고 느껴서 추가한 내용들입니다.</p>

<h4 id="1-로딩뷰-구현">1. 로딩뷰 구현</h4>

<p>페어링하고 기기를 탐색하는 과정에서 생각보다 시간이 많이 소요되서 로딩뷰를 추가하기로 했습니다. 그냥 로딩뷰로 구글에 검색하니 오픈 소스가 존재해서 추가해 사용했습니다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">BluetoothTableViewController</span><span class="o">.</span><span class="n">h</span>
<span class="kd">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="kt">MBProgressHUD</span> <span class="o">*</span><span class="n">prograss</span><span class="p">;</span>

<span class="kt">BluetoothTableViewController</span><span class="o">.</span><span class="n">m</span>
<span class="n">_prograss</span> <span class="o">=</span> <span class="p">[[</span><span class="kt">MBProgressHUD</span> <span class="n">alloc</span><span class="p">]</span> <span class="nv">initWithView</span><span class="p">:</span><span class="k">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">view</span><span class="p">];</span>
<span class="p">[</span><span class="k">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">view</span> <span class="nv">addSubview</span><span class="p">:</span><span class="n">_prograss</span><span class="p">];</span>
</code></pre></div></div>

<p>탐색 중에는 로딩뷰로 화면을 가려 버리면 유저가 원하는 아이템을 찾았을 때 문제가 있을거 같아서 네트워크 인디게이터로 대체했습니다. 하지만 커넥션은 로딩을 보여줘야 할거 같아서 커넥션을 수행할 때 로딩뷰를 보여주고 didconnection이 호출되면 그때 로딩뷰를 없애는 형식을 취했습니다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">connetSelectedPeriphral</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">_prograss</span> <span class="nv">setLabelText</span><span class="p">:</span><span class="s">@"Openit FIDO"</span><span class="p">];</span>
    <span class="p">[</span><span class="n">_prograss</span> <span class="nv">setDetailsLabelText</span><span class="p">:</span><span class="s">@"connecting with device"</span><span class="p">];</span>
    <span class="p">[</span><span class="n">_prograss</span> <span class="nv">showUsingAnimation</span><span class="p">:</span><span class="kt">YES</span><span class="p">];</span>
    <span class="p">[</span><span class="n">_centralManager</span> <span class="nv">connectPeripheral</span><span class="p">:</span><span class="n">_discoveredPeripheral</span> <span class="nv">options</span><span class="p">:</span><span class="err">@</span><span class="p">{</span><span class="kt">CBConnectPeripheralOptionNotifyOnConnectionKey</span><span class="p">:</span><span class="kd">@YES</span><span class="p">}];</span>
<span class="p">}</span>
<span class="o">-</span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">connectedDonePeriphral</span> <span class="p">{</span>
    <span class="p">[</span><span class="k">self</span> <span class="nv">stopSearch</span><span class="p">:</span><span class="k">self</span><span class="p">];</span>
    <span class="p">[</span><span class="n">_prograss</span> <span class="nv">hideUsingAnimation</span><span class="p">:</span><span class="kc">true</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="2-페어링-이력이-있는-디바이스-자동-패어링">2. 페어링 이력이 있는 디바이스 자동 패어링</h4>

<p>사용자의 개인 Authenticator를 계속 사용하는 것을 지향하고 있기 때문에 인증이 과거 연결 이력이 있으면 자동 연결이 가능하도록 했습니다.</p>

<p>먼저, 연결을 성공하면 UserDefault에 기기 정보를 저장하도록 합니다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="nv">centralManager</span><span class="p">:(</span><span class="kt">CBCentralManager</span> <span class="o">*</span><span class="p">)</span><span class="n">central</span> <span class="nv">didConnectPeripheral</span><span class="p">:(</span><span class="kt">CBPeripheral</span> <span class="o">*</span><span class="p">)</span><span class="n">peripheral</span> <span class="p">{</span>
    <span class="p">[</span><span class="k">self</span> <span class="n">connectedDonePeriphral</span><span class="p">];</span>
    <span class="p">[</span><span class="kt">OpenitUtils</span> <span class="nv">savePeripheral</span><span class="p">:</span><span class="n">peripheral</span><span class="p">];</span>
    <span class="n">_discoveredPeripheral</span> <span class="o">=</span> <span class="n">peripheral</span><span class="p">;</span>
    <span class="p">[</span><span class="k">self</span> <span class="nv">performSegueWithIdentifier</span><span class="p">:</span><span class="s">@"GoCheckView"</span> <span class="nv">sender</span><span class="p">:</span><span class="k">self</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">OpenitUtils</span><span class="o">.</span><span class="n">m</span>
<span class="o">+</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span> <span class="nv">savePeripheral</span><span class="p">:(</span><span class="kt">CBPeripheral</span><span class="o">*</span><span class="p">)</span><span class="n">peripheral</span> <span class="p">{</span>
    <span class="kt">NSUserDefaults</span> <span class="o">*</span><span class="n">userDefaults</span> <span class="o">=</span> <span class="p">[</span><span class="kt">NSUserDefaults</span> <span class="n">standardUserDefaults</span><span class="p">];</span>
    <span class="p">[</span><span class="n">userDefaults</span> <span class="nv">setObject</span><span class="p">:</span><span class="n">peripheral</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="kt">UUIDString</span> <span class="nv">forKey</span><span class="p">:</span><span class="kt">WSB_IDENTIFIER</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>이후에는 저장된 기기 이력이 있다면 사용자에게 그 기기와 연결을 묻습니다.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">viewDidLoad</span> <span class="p">{</span>
<span class="k">if</span><span class="p">([</span><span class="kt">OpenitUtils</span> <span class="n">isSavedPeripheral</span><span class="p">])</span> <span class="p">{</span>
        <span class="kt">NSString</span> <span class="o">*</span><span class="n">uuidString</span> <span class="o">=</span> <span class="p">[</span><span class="kt">OpenitUtils</span> <span class="n">getSavedPeripheralUUIDString</span><span class="p">];</span>
        <span class="kt">NSUUID</span> <span class="o">*</span><span class="n">uuid</span> <span class="o">=</span> <span class="p">[[</span><span class="kt">NSUUID</span> <span class="n">alloc</span><span class="p">]</span> <span class="nv">initWithUUIDString</span><span class="p">:</span><span class="n">uuidString</span><span class="p">];</span>
        <span class="kt">NSArray</span><span class="o">*</span> <span class="n">periphralarray</span> <span class="o">=</span> <span class="p">[</span><span class="n">_centralManager</span> <span class="nv">retrievePeripheralsWithIdentifiers</span><span class="p">:</span><span class="err">@</span><span class="p">[</span><span class="n">uuid</span><span class="p">]];</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">CBPeripheral</span> <span class="o">*</span><span class="n">periphral</span> <span class="k">in</span> <span class="n">periphralarray</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">[</span><span class="n">_peripheralList</span> <span class="nv">addObject</span><span class="p">:</span><span class="n">periphral</span><span class="p">];</span>
            <span class="n">_discoveredPeripheral</span> <span class="o">=</span> <span class="n">periphral</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">_discoveredPeripheral</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">[</span><span class="k">self</span><span class="o">.</span><span class="n">tableView</span> <span class="n">reloadData</span><span class="p">];</span>
            <span class="p">[</span><span class="k">self</span> <span class="n">showAlert</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="o">-</span><span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">showAlert</span> <span class="p">{</span>
    <span class="kt">UIAlertAction</span> <span class="o">*</span><span class="n">cancel</span> <span class="o">=</span> <span class="p">[</span><span class="kt">UIAlertAction</span> <span class="nv">actionWithTitle</span><span class="p">:</span><span class="s">@"cancel"</span> <span class="nv">style</span><span class="p">:</span><span class="kt">UIAlertActionStyleDestructive</span> <span class="nv">handler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">UIAlertAction</span> <span class="o">*</span> <span class="n">_Nonnull</span> <span class="n">action</span><span class="p">)</span> <span class="p">{</span>

    <span class="p">}];</span>
    <span class="kt">UIAlertAction</span> <span class="o">*</span><span class="n">connect</span> <span class="o">=</span> <span class="p">[</span><span class="kt">UIAlertAction</span> <span class="nv">actionWithTitle</span><span class="p">:</span><span class="s">@"connect"</span> <span class="nv">style</span><span class="p">:</span><span class="kt">UIAlertActionStyleDefault</span> <span class="nv">handler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">UIAlertAction</span> <span class="o">*</span> <span class="n">_Nonnull</span> <span class="n">action</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">NSLog</span><span class="p">(</span><span class="s">@"try connect :%@, state: %ld"</span><span class="p">,</span><span class="n">_discoveredPeripheral</span><span class="o">.</span><span class="n">name</span><span class="p">,(</span><span class="n">long</span><span class="p">)</span><span class="n">_discoveredPeripheral</span><span class="o">.</span><span class="n">state</span><span class="p">);</span>
        <span class="p">[</span><span class="k">self</span> <span class="n">connetSelectedPeriphral</span><span class="p">];</span>
    <span class="p">}];</span>

    <span class="p">[</span><span class="kt">OpenitUtils</span> <span class="nv">showAlertBox</span><span class="p">:</span><span class="k">self</span> <span class="kt">Title</span><span class="p">:</span><span class="s">@"Openit Fido"</span> <span class="kt">Message</span><span class="p">:</span><span class="s">@"do you want to connetd the saved device?"</span> <span class="kt">Actions</span><span class="p">:</span><span class="err">@</span><span class="p">[</span><span class="n">cancel</span><span class="p">,</span><span class="n">connect</span><span class="p">]];</span>
<span class="p">}</span>
</code></pre></div></div>

                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
            

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            
                <section class="post-full-comments">
                    <div id="disqus_thread"></div>
                    <script>
                        var disqus_config = function () {
                            this.page.url = 'https://leejigun.github.io//';
                            this.page.identifier = 'iOS 삽질 블로그';
                        };
                        (function() {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://jglee.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    </script>
                </section>
            

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            style="background-image: url(/assets/images/blog-cover.jpg)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; iOS 삽질 블로그 &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/tag/ios/">Ios</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/DI_using_Swinject">DI(의존성 주입) using Swinject</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/fastlane_release_testflight">fastlane - release, testflight</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/fastlaneFirebase">iOS fastlane - Fabric, Firebase</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/tag/ios/">
                                
                                    See all 16 posts  →
                                
                            </a>
                        </footer>
                    </article>
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            
                
    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/IGListKit">
                <div class="post-card-image" style="background-image: url(/assets/images/IGListKit/profile.png)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/IGListKit">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Ios</span>
                            
                        
                    

                    <h2 class="post-card-title">IGListKit 가이드(1)- 모델 바인딩</h2>
                </header>
                <section class="post-card-excerpt">
                    <p>* [IGListKit](https://github.com/Instagram/IGListKit) * [[IGListKit Tutorial](https://www.raywenderlich.com/147162/iglistkit-tutorial-better-uicollectionviews)](https://www.raywenderlich.com/147162/iglistkit-tutorial-better-uicollectionviews) IGListkit에 대한 가이드가 많이 있지만, 버전이 3.0으로 올라가면서 binding 부분이 강화되면서 변경된 부분들에 대한 포스트가 미흡하여 인스타그램의 예제를 보충하려 한다. ## Modeling and Binding과 필요성 우선 [예제](https://github.com/rnystrom/IGListKit-Binding-Guide)를 fork</p>
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </footer>
        </div>
    </article>

            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="https://leejigun.github.io//">
            
                <img src="/assets/images/blog-icon.png" alt="iOS 삽질 블로그 icon" />
            
            <span>iOS 삽질 블로그</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">CoreBluetooth 가이드</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=CoreBluetooth+%EA%B0%80%EC%9D%B4%EB%93%9C&amp;url=https://leejigun.github.io/CoreBlutooth"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://leejigun.github.io/CoreBlutooth"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://leejigun.github.io//">iOS 삽질 블로그</a> &copy; 2023</section>
                <section class="poweredby">Github page blog of <a href="https://github.com/Leejigun">Leejigun</a> &
                    <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> using
                    <a href="https://github.com/jekyller/jasper2" target="_blank" rel="noopener">Jasper2</a></section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    
                    
                    <!-- <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a> -->
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-154736789-1', 'auto');
  ga('send', 'pageview');

 </script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->

</body>
</html>
